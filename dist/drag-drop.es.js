var e=Object.defineProperty,t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,o=(t,n,a)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[n]=a,s=(e,s)=>{for(var r in s||(s={}))n.call(s,r)&&o(e,r,s[r]);if(t)for(var r of t(s))a.call(s,r)&&o(e,r,s[r]);return e};function r(){let e,t;const n=new Promise(((n,a)=>{e=n,t=a}));return{promise:n,done:e,cancel:t,onComplete:c(n)}}function c(e){return function(t){e.then((e=>t(e)))}}const i=function(e){let t,n=!1;e?(t=function(e){let t=e.map((e=>r())),n=t.map((e=>e.promise));return t.promises=n,t.onComplete=c(Promise.all(n)),t}(e),n=!0):t=r();return t.timeout=function(e,t){let n;n=e?Promise.all(t.promises):t.promise;return function(e,a){let o,s=new Promise(((t,s)=>{o=setTimeout((()=>{t(a),Promise.resolve(n)}),e)}));return n.then((()=>clearTimeout(o))),t.onComplete=c(Promise.race([n,s])),t}}(n,t),t},d={_setTransitions:function(){return function(e,t){let n={},a={},o={};return e.forEach((e=>{const[s,r,c,i,d]=e,l=t[i],u=`${s}/${r}`;n[u]=l||null,a[u]=c,function(e){return e instanceof Array&&(2==e.length&&(e.forEach((e=>{if(!1!==e||"string"!=typeof e)return!1})),!0))}(d)&&(o[u]=[],o[u][0]=d[0],o[u][1]=d[1])})),{transitions:n,nextState:a,chainActions:o}}},_updateStep:function(e){return function(t,n,a){const o=e.askForPromise(),s=`${e.state}/${n}`,r=e.callback;e.lock=!0,e._transit(o,s,a),o.onComplete((n=>{let a=e._getChain(e.chainActions,s),o=n.response;if(n.success){if(e.state=e.nextState[s],n.stateData&&(e.stateData=n.stateData),r.positive.forEach((t=>t(e.state,o))),r.transition.forEach((t=>t(e.state,o))),a&&a[0])return void e._updateStep(t,a[0],o)}else if(r.negative.forEach((t=>t(e.state,o))),r.transition.forEach((t=>t(e.state,o))),a&&a[1])return void e._updateStep(t,a[1],o);n.command?e._updateStep(t,n.command,o):t.done(o)})),o.promise.catch((()=>console.log(`Failed in step ${s}`)))}},_warn:function(e){return function(e){Object.keys(e).forEach((t=>{null==e[t]&&console.log(`Warning: Transition for ${t} is not defined`)}))}},_transit:function(e){return function(t,n,a){const o=e.dependencies,r=s({},e.stateData),c=e.transitions[n];"function"==typeof c?c(t,o,r,a):t.done({success:!1})}},_getChain:function(){return function(e,t){return!!e[t]&&e[t]}},_triggerCacheUpdate:function(e){return function(){if(0!==e.cache.length){const{updateTask:t,action:n,dt:a}=e.cache[0];e.cache=e.cache.reduce(((e,t,n)=>(0!=n&&e.push(t),e)),[]),e._updateStep(t,n,a),t.onComplete((t=>e._onUpdateTask(t)))}}},_onUpdateTask:function(e){return function(t){const n=e.callback,a=e.askForPromise(n.update);n.update.forEach(((n,o)=>{n(e.state,t),a[o].done()})),a.onComplete((t=>{e.lock=!1,e._triggerCacheUpdate()}))}},setDependencies:function(e){return function(t){e.dependencies=s(s({},e.dependencies),t)}},on:function(e){return function(t,n){const a=e.callback;a[t]&&a[t].push(n)}},off:function(e){return function(t){e.callback[t]&&(e.callback[t]=[])}},importState:function(e){return function({state:t,stateData:n}){t&&(e.state=t,e.stateData=s({},n))}},exportState:function(e){return function(){return{state:e.state,stateData:s({},e.stateData)}}},update:function(e){return function(t,n){const a=e.askForPromise();return e.lock?(e.cache.push({updateTask:a,action:t,dt:n}),a.promise):(e._updateStep(a,t,n),a.onComplete((t=>e._onUpdateTask(t))),a.promise)}},reset:function(e){return function(){e.state=e.initialState,e.stateData=e.initialStateData}},ignoreCachedUpdates:function(e){return function(){e.cache.forEach((({updateTask:e,action:t,dt:n})=>e.cancel(`Action '${t}' was ignored`))),e.cache=[]}},getState:function(e){return function(){return e.state}}};var l=function({init:e,table:t,stateData:n,debug:a},o={}){const r=this,c=Object.keys(d);r.state=e||"N/A",r.initialState=e||"N/A",r.lock=!1,r.cache=[],r.askForPromise=i,r.stateData=s({},n),r.initialStateData=s({},n),r.dependencies={},r.callback={update:[],transition:[],positive:[],negative:[]},c.forEach((e=>r[e]=d[e](r)));const{transitions:l,nextState:u,chainActions:p}=r._setTransitions(t,o);a&&r._warn(l),r.transitions=l,r.nextState=u,r.chainActions=p};function u(e){return{mouseDown:t=>{t.target.draggable||e.update("select",{event:t})},mouseUp:t=>{t.target.draggable?t.altKey?e.update("removeItem",{event:t}):t.shiftKey?e.update("addItem",{event:t}):e.update("newSelection",{event:t}):e.update("end",{event:t})},mouseMove:t=>e.update("move",{event:t}),dragStart:t=>e.update("drag",{event:t}),dragEnd:t=>e.update("end",{event:t}),dragOver:e=>e.preventDefault(),dragEnter:t=>e.update("move",{event:t}),drop:t=>e.update("drop",{event:t})}}const p={minMax:function({startX:e,startY:t,newX:n,newY:a}){return{xMin:Math.min(e,n),xMax:Math.max(e,n),yMin:Math.min(t,a),yMax:Math.max(t,a)}},updateSelection:function(e,t){const{xMin:n,xMax:a,yMin:o,yMax:s}=e;t.style.left=`${n}px`,t.style.top=`${o}px`,t.style.width=a-n+"px",t.style.height=s-o+"px"},drawSelection:function(e,t){let n;return t?(n=t,n.style.visibility="visible"):(n=document.createElement("div"),n.style.position="absolute",n.style.border="1px dotted #333",document.getElementsByTagName("body")[0].appendChild(n)),n.style.left=`${e.clientX}px`,n.style.top=`${e.clientY}px`,n.style.width="20px",n.style.height="20px",n},targetList:function(e){return function(){let t=document.querySelectorAll("[draggable]"),n=[];return t.forEach((t=>{t.parentNode==e&&n.push(t)})),n}},getEventFunctions:u};const g={onDrop:function({event:e,dragged:t,selection:n,log:a}){n.forEach((t=>{t.parentNode.removeChild(t),e.target.appendChild(t)})),t.style=""},onStartDragging:function({event:e,selection:t,draggedTransperency:n,selectStyle:a}){t.forEach((e=>{e.style.opacity=n,e.classList.add(a)}))}},f={init:"none",table:[["none","start","wait","setConfig",["start",!1]],["wait","start","ready","start"],["ready","addItem","ready","addSingleItem"],["ready","newSelection","ready","replaceSelection"],["ready","removeItem","ready","removeSingleItem"],["ready","select","inSelect","startSelection"],["inSelect","move","inSelect","changeSelection"],["inSelect","end","ready","endSelection"],["ready","drag","inDrag","startDragging"],["inDrag","end","ready","endDragging"],["inDrag","move","inDrag","changeDragZone"],["inDrag","drop","inDrag","drop"],["ready","disable","off","disable"],["off","enable","ready","enable"],["off","changeConfig","off","setConfig"],["ready","changeConfig","ready","setConfig"],["ready","destroy","end","destroy"],["off","destroy","end","destroy"]],stateData:{dropStyle:"dropzone",selectStyle:"dd-select",draggedTransperency:.5,selection:[],dragged:null,activeDropZone:null,activeZoneStyle:"actZone",selectDraw:null,mouseSelection:!1,startX:0,startY:0,newX:!1,newY:!1}};const m={start:function(e,t,n,a){let{eFn:o}=t;document.addEventListener("mousedown",o.mouseDown),document.addEventListener("mousemove",o.mouseMove),document.addEventListener("mouseup",o.mouseUp),document.addEventListener("dragstart",o.dragStart),document.addEventListener("dragend",o.dragEnd),document.addEventListener("dragover",o.dragOver),document.addEventListener("dragenter",o.dragEnter),document.addEventListener("drop",o.drop),e.done({success:!0,response:a})},startSelection:function(e,t,n,a){const{event:o}=a,{fn:s}=t,{selectDraw:r}=n;o.preventDefault(),n.selectDraw=s.drawSelection(o,r),n.mouseSelection=!0,n.startX=o.clientX,n.startY=o.clientY,e.done({success:!0,stateData:n})},changeSelection:function(e,t,n,a){let{mouseSelection:o,selectDraw:s,startX:r,startY:c}=n,{event:i}=a,{fn:d}=t;if(!o)return void e.done({success:!1});i.preventDefault();let l=i.clientX,u=i.clientY;d.updateSelection(d.minMax({startX:r,startY:c,newX:l,newY:u}),s),n.newX=l,n.newY=u,e.done({success:!0,stateData:n})},endSelection:function(e,t,n,a){let{event:o}=a,{fn:s}=t,{startX:r,startY:c,newX:i,newY:d,selectDraw:l,selectStyle:u}=n,p=[],g="new";if(o.preventDefault(),l.style.visibility="hidden",!i)return n.selection.forEach((e=>e.classList.remove(u))),n.selection=[],void e.done({success:!0,stateData:n});o.altKey&&(g="reduce"),o.shiftKey&&(g="expand"),"expand"!==g&&n.selection.forEach((e=>e.classList.remove(u)));let{xMin:f,xMax:m,yMin:v,yMax:y}=s.minMax({startX:r,startY:c,newX:i,newY:d});switch(document.querySelectorAll("[draggable]").forEach((e=>{let t=!0;if(t&&(t=e.offsetLeft>f),t&&(t=e.offsetTop>v),t){t=e.offsetLeft+e.clientWidth<m}if(t){t=e.offsetTop+e.clientHeight<y}t&&p.push(e)})),g){case"new":n.selection=p.map((e=>(e.classList.add(u),e)));break;case"expand":n.selection=p.reduce(((e,t)=>(e.includes(t)||(e.push(t),t.classList.add(u)),e)),n.selection);break;case"reduce":n.selection=n.selection.reduce(((e,t)=>(p.includes(t)||(e.push(t),t.classList.add(u)),e)),[])}n.mouseSelection=!1,n.newX=!1,n.newY=!1,e.done({success:!0,stateData:n})},addSingleItem:function(e,t,n,a){let{event:o}=a,s=o.target,{selection:r,selectStyle:c}=n;r.includes(s)||(r.push(s),s.classList.add(c)),e.done({success:!0,stateData:n})},removeSingleItem:function(e,t,n,a){let{event:o}=a,s=o.target,{selection:r,selectStyle:c}=n;n.selection=r.reduce(((e,t)=>(t!=s?e.push(t):t.classList.remove(c),e)),[]),e.done({success:!0,stateData:n})},replaceSelection:function(e,t,n,a){let{event:o}=a,{selectStyle:s}=n,r=o.target;n.selection.forEach((e=>e.classList.remove(s))),r.classList.add(s),n.selection=[r],e.done({success:!0,stateData:n})},startDragging:function(e,t,n,a){let{event:o}=a,{draggedTransperency:s,selection:r,selectStyle:c}=n,{hooks:i}=t;0===r.length&&(r=[o.target]),i.onStartDragging({event:o,selection:r,draggedTransperency:s,selectStyle:c}),n.dragged=o.target,n.selection=r,n.activeDropZone=o.target.parentNode,e.done({success:!0,stateData:n})},changeDragZone:function(e,t,n,a){let{event:o}=a,{activeDropZone:s,activeZoneStyle:r,dropStyle:c}=n,i=o.target==s,d=o.target.parentNode==s,l=o.target.classList.contains(c);if(!i&&!d)return l?(s.classList.remove(r),o.target.classList.add(r),n.activeDropZone=o.target,void e.done({success:!0,stateData:n})):void e.done({success:!1});e.done({success:!1})},endDragging:function(e,t,n,a){let{activeDropZone:o,activeZoneStyle:s,selection:r,selectStyle:c}=n;o.classList.remove(s),r.forEach((e=>{e.classList.remove(c),e.style.opacity="",e.style[0]||e.removeAttribute("style")})),n.activeDropZone=null,n.selection=[],e.done({success:!0,stateData:n})},drop:function(e,t,n,a){let{event:o}=a,{activeDropZone:s,dragged:r,selection:c}=n,{hooks:i,fn:d}=t,l=s==o.target,u=[],p=d.targetList(o.target);o.preventDefault(),c.forEach((e=>{let t=d.targetList(e.parentNode),n={source:e.parentNode,target:o.target,el:e,targetList:p,sourceList:t};u.push(n)})),l&&i.onDrop({event:o,dragged:r,selection:c,log:u}),e.done({success:!0})},destroy:function(e,t,n,a){let{eFn:o}=t;document.removeEventListener("mousedown",o.mouseDown),document.removeEventListener("mousemove",o.mouseMove),document.removeEventListener("mouseup",o.mouseUp),document.removeEventListener("dragstart",o.dragStart),document.removeEventListener("dragend",o.dragEnd),document.removeEventListener("dragover",o.dragOver),document.removeEventListener("dragenter",o.dragEnter),document.removeEventListener("drop",o.drop),e.done({success:!0})},setConfig:function(e,t,n,a={}){let{hooks:o,config:s}=a;o||(o={}),s||(s={}),s.onStartDragging&&(o.onStartDragging=s.onStartDragging),s.onDrop&&(o.onDrop=s.onDrop),s.dropStyle&&"string"==typeof s.dropStyle&&(n.dropStyle=s.dropStyle),s.draggedTransperency&&"number"==typeof s.draggedTransperency&&(n.draggedTransperency=s.draggedTransperency),s.activeZoneStyle&&"string"==typeof s.activeZoneStyle&&(n.activeZoneStyle=s.activeZoneStyle),s.selectStyle&&"string"==typeof s.selectStyle&&(n.selectStyle=s.activeZoneStyle),e.done({success:!0,stateData:n,response:o})},disable:function(e,t,n,a){e.done({success:!0})},enable:function(e,t,n,a){e.don({success:!0})}};function v(e){const t=new l(f,m),n=u(t),a=t.askForPromise;return window.dd=t,t.setDependencies({eFn:n,fn:p,askForPromise:a}),t.update("start",{config:e,hooks:g}).then((e=>t.setDependencies({hooks:e}))).then((()=>({changeConfig:e=>{t.update("changeConfig",{hooks:g,config:e}).then((e=>t.setDependencies({hooks:e})))},destroy:()=>t.update("destroy"),disable:()=>t.update("disable"),enable:()=>t.update("enable")})))}export default v;
