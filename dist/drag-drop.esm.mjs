function e(e){let o,r=!1;return e?(o=function(e){let o=e.map((e=>t())),r=o.map((e=>e.promise));return o.promises=r,o.onComplete=n(Promise.all(r)),o}(e),r=!0):o=t(),o.timeout=function(e,t){let o;return o=e?Promise.all(t.promises):t.promise,function(e,r){let a,s=new Promise(((t,n)=>{a=setTimeout((()=>{t(r),Promise.resolve(o)}),e)}));return o.then((()=>clearTimeout(a))),t.onComplete=n(Promise.race([o,s])),t}}(r,o),o}function t(){let e,t;const o=new Promise(((n,o)=>{e=n,t=o}));return{promise:o,done:e,cancel:t,onComplete:n(o)}}function n(e){return function(t){e.then((e=>t(e)))}}function o(e){return null==e||e.nodeType?"simple":e instanceof Array?"array":"object"==typeof e?"object":"simple"}function r(e,t,n,r,s,...c){let[i,u]=r;Object.keys(e).forEach((l=>{let d=o(e[l]),f=e[l],p="array"===o(t),g=!isNaN(l),h=Symbol("ignore___");if("simple"!==d&&u){if(f=u({value:f,key:l,breadcrumbs:`${s}/${l}`,IGNORE:h},...c),f===h)return;d=o(f)}if("simple"===d){if(!i)return void(t[l]=f);let e=i({value:f,key:l,breadcrumbs:`${s}/${l}`,IGNORE:h},...c);if(e===h)return;const n=function(e,t){return t instanceof Array&&!isNaN(e)}(l,t);n?t.push(e):t[l]=e}if("object"===d){const e={};p&&g?t.push(e):t[l]=e,n.push(a(f,e,n,r,`${s}/${l}`,c))}if("array"===d){const e=[];p&&g?t.push(e):t[l]=e,n.push(a(f,e,n,r,`${s}/${l}`,c))}}))}function*a(e,t,n,o,a,s){yield r(e,t,n,o,a,...s)}function s({data:e,keyCallback:t,objectCallback:n},...a){let s,c=[],i="root",u=[t,n];switch(o(e)){case"array":s=[],r(e,s,c,u,i,...a);break;case"object":s={},r(e,s,c,u,i,...a);break;case"simple":return e}for(const e of c)e.next();return s}function c(e,t){return function(n,o){const{convert:r,isDTO:a,isDTM:s,walk:c}=e();let i,u;a(o)?(i=o.export(),u=o.copy()):s(o)?(i=c({data:o}),u=c({data:o})):([u,,i]=r.from("std").toFlat(e,o),console.warn('A non "dt-object" data segment was inserted. Autoconverted to "dt-object".'));const l=new RegExp("^root/");i.forEach((e=>{e[0]===e[2]&&(e[0]=n,e[2]=n),e[2]=e[2].replace(l,`${n}/`),e[3].forEach(((t,o)=>e[3][o]=t.replace(l,`${n}/`)))})),t.insert([u,,i])}}function i(e,t){return e=>t.export(e)}function u(e,t){return function(n="root"){const o=t.getCopy(n),{walk:r}=e();return o?r({data:o}):null}}function l(e,t,n){return function(){let o=[],r={};const{convert:a,draft:s,INIT_DATA_TYPES:c,main:{load:i}}=e(),u={set:s.set(o,r),connect:s.connect(r),save:s.save(r),push:s.push(r)},[l,...d]=arguments,{as:f}=l({...n,...u},...d)||{},p=0===o.length?t.export():o,g=!!f&&c.includes(f);let h;return"dt-object"===f?i(p):f&&!g?(console.error(`Model '${f}' is unknown data-model.`),null):(h=f?a.to(f,e,p):i(p),t.resetScan(),h)}}function d(e,t,n){return function(){const{main:{load:o},draft:r}=e(),[a,...s]=arguments;let c=[],i={};const u={set:r.set(c,i),connect:r.connect(i),save:r.save(i),push:r.push(i)};return a({...n,...u},...s),t.resetScan(),0===c.length?this:o(c)}}function f(e){return function(t,n){e.setupFilter(t,n)}}function p(e,t){const{flatData:n}=e(),[o,r]=n(e,t),a={insertSegment:c(e,o),export:i(0,o),copy:u(e,o),model:l(e,o,r),query:d(e,o,r),setupFilter:f(o),listSegments:()=>Object.keys(o.getIndexes()).reduce(((e,t)=>(t.includes("/")||e.push(t),e)),[]),index:s};function s(e){if(null==e)return null;let t=o.getLine(e);if(t){let e,[n,o,r,a]=t;return e=o instanceof Array?[...o]:{...o},[n,e,r,[...a]]}return null}return a.extractList=function(e,t,n){return function(o,r){const a=n("root"),{main:{load:s},INIT_DATA_TYPES:c}=e(),i=[...c,"dt-object"];let u=!1,l="";if(r&&(r.as||(u=!0,l='Options should be an object and property "as" is required'),u||i.includes(r.as)||(u=!0,l=`Invalid option "as" value: ${r.as}.`),u))throw new Error(l);return o.map((e=>{let n=t.export(e);return 0===n.length?a[1].hasOwnProperty(e)?a[1][e]:null:n})).map((e=>null==e?null:e instanceof Array?s(e).model((()=>r)):e))}}(e,o,s),a}function g(e,t,n){return function(o){const[r,,a]=o,s=a[0][0],[c,i,u]=e,l=n();c[s]=r,a.forEach((e=>{const[,,n]=e;i[n]=e,u.push(e),l.forEach((n=>t(n,e)))}))}}function h(e){return function(t){const[,n,o]=e;if(t&&!n[t])return[];if(!t){const e=[];return o.forEach((t=>{const[n,o,r,a]=t,s=o instanceof Array?[...o]:{...o};e.push([n,s,r,[...a]])})),e}const r=[];return o.forEach((e=>{const[n,o,a,s]=e,c=new RegExp(`^${t}/`);if(a===t||a.match(c)){let e=n===a?"root":n,t=o instanceof Array?[...o]:{...o},i=a.includes("/")?a.replace(c,"root/"):"root",u=s.map((e=>e.replace(c,"root/")));r.push([e,t,i,u])}})),r}}function m(e,t,n,o){return function(r,a){const s=o(),[,,c]=e;if(s.includes(r))return console.error(`Filter name "${r}" is already defined`),this;t[r]=a,c.forEach((e=>n(r,e)))}}function y(e){return function(t){const n=e.getIndexes(),o=n[t],r=[];return o?(r.push(o),v(n,r,o[3]),e.setupScanList(r),this):(e.setupScanList([]),this)}}function v(e,t,n){n.forEach((n=>{const o=e[n];o&&(t.push(o),v(e,t,o[3]))}))}function b(e){return function(t){const n=[];return e.getScanList().forEach((e=>{e[0]===t&&n.push(e)})),e.setupScanList(n),this}}function S(e){return function(t){const n=[],o=t instanceof Array?t:[t];return e.getScanList().forEach((e=>{const t=e[0];o.forEach((o=>{t.includes(o)&&n.push(e)}))})),e.setupScanList(n),this}}function D(e){return function(t){e.getScanList().forEach((n=>{const[o,r,a,s]=n,c=r instanceof Array,i=()=>"$__NEXT__LOOK_",u=()=>"$__FINISH__WITH__THE__LOOKING_";let l=!1;const d=s.map((e=>{let t=e.replace(`${a}/`,"");return[o,t]}));if(c)0===r.length?f([]):r.every(((e,n)=>{if(l)return!1;const s=t({value:e,key:n,name:o,flatData:r,breadcrumbs:a,links:d,next:i,finish:u});return"$__FINISH__WITH__THE__LOOKING_"===s&&(l=!0),!["$__FINISH__WITH__THE__LOOKING_","$__NEXT__LOOK_"].includes(s)}));else{const e=Object.entries(r);0===e.length?f({}):e.every((([e,n])=>{if(l)return!1;const s=t({value:n,key:e,name:o,flatData:r,breadcrumbs:a,links:d,next:i,finish:u});return"$__FINISH__WITH__THE__LOOKING_"===s&&(l=!0),!["$__FINISH__WITH__THE__LOOKING_","$__NEXT__LOOK_"].includes(s)}))}function f(e){t({value:null,key:null,name:o,flatData:e,breadcrumbs:a,links:d,empty:!0,next:i,finish:u})}e.resetScan()}))}}function E(e){return function(t){const n=[];return e.getScanList().every((e=>e[2]!==t||(n.push(e),!1))),e.setupScanList(n),this}}function k({flatData:e}){return e instanceof Array}function x({name:e,flatData:t}){return!(t instanceof Array||isNaN(e))}function $({flatData:e}){return!(e instanceof Array)}function _({name:e,breadcrumbs:t}){return e===t}function L(e,t){const[n,o,r]=t,a=[n,o,r],s={},c={list:k,listObject:x,object:$,root:_};let i=r;const u=()=>Object.keys(c),l=(e,t)=>{if(c[e]){const[n,r,a,i]=t;if(s[e]||(s[e]=[]),c[e]({name:n,flatData:r,breadcrumbs:a,edges:i})){const t=o[a];s[e].push(t)}}};u().forEach((e=>r.forEach((t=>l(e,t)))));const d={insert:g(a,l,u),export:h(a),getCopy:e=>n[e]?n[e]:null,getIndexes:()=>o,getLine:e=>o[e]?o[e]:null,getFilters:()=>s,getScanList:()=>i,setupScanList:e=>i=e,setupFilter:m(a,c,l,u),resetScan:()=>{i=r}};var f;return[d,{from:y(d),use:(f=d,function(e){const t=f.getFilters()[e];return t&&f.setupScanList(t),this}),get:E(d),find:b(d),like:S(d),look:D(d)}]}e.sequence=function(t,...n){const o=e(),r=[],a=function*(e){for(const t of e)yield t}(t);return function e(t,...n){t.done?o.done(r):t.value(...n).then((t=>{r.push(t),e(a.next(),...n,t)}))}(a.next(),...n),o},e.all=function(t,...n){const o=e(),r=[],a=t.map(((e,t)=>"function"==typeof e?e(...n).then((e=>r[t]=e)):e.then((e=>r[t]=e))));return Promise.all(a).then((()=>o.done(r))),o};var w=function(e,t){const n=t instanceof Array?[]:{},{walk:o}=e(),r=[["root",n,"root",[]]],a={root:r[0]},s=o({data:t,keyCallback:function({value:e,key:t,breadcrumbs:n}){const o=new RegExp(`/${t}$`),r=n.replace(o,"");return a[r][1][t]=e,e},objectCallback:function({value:e,key:t,breadcrumbs:n}){const o=e instanceof Array?[]:{},s=t,c=new RegExp(`/${t}$`),i=n.replace(c,""),u=[s,o,n,[]];return a[i][3].push(n),r.push(u),a[n]=r.at(-1),e}});return[{root:s},a,r]},O=function(e){let t={};return e.reverse().forEach((([e,n,o,r])=>{const a=n instanceof Array?[...n]:{...n};t[o]=a,r.forEach((e=>{if(t[e]){const n=e.replace(`${o}/`,"");t[o][n]=t[e]}}))})),t.root},j=function(e,t){const n=Object.entries(t),{walk:o}=e(),r={},a=[],s={},c={};function i(e){s[e]||(s[e]="object");const t=e.split("/");1!=t.length&&(t.pop(),1!=t.length&&i(t.join("/")))}return n.forEach((([e,t])=>{e.startsWith("root")||(e=`root/${e}`),i(e),function(e,t){Object.keys(t).forEach((t=>{isNaN(t)||(s[e]="array")}))}(e,t),c[e]=t})),Object.entries(s).forEach((([e,t])=>{if("object"===c[e])return;if(c[e]){const n=c[e]instanceof Array;if("array"===t&&!n){const t=Object.values(c[e]);c[e]=t}return}const n="object"===t?{}:[];c[e]=n})),Object.entries(c).sort().forEach((([e,t])=>{const n=e.split("/").pop(),o=e.replace(`/${n}`,""),s=[n,t instanceof Array?[...t]:{...t},e,[]];r[e]=s,a.push(s),"root"!==e&&o&&r[o]&&r[o][3].push(e)})),[o({data:t}),r,a]},T=function(e){const t={};return e.forEach((e=>{const[,n,o]=e;if(0===Object.keys(n).length)return;const r=o.replace("root/",""),a=n instanceof Array?[...n]:{...n};t[r]=a})),t},A=function(e,t){const{walk:n}=e(),o={},r={root:[]},a=[];function s(e){if("root"===e)return;const t=e.split("/");t.pop();const n=t.join("/");r[n]||(r[n]=[]),n.includes("/")&&s(n)}t.forEach((e=>{const[t,n]=e,o="root"===t?"root":`root/${t}`;r[o]?r[o].push(n):r[o]=[n],s(o)}));let c=Object.entries(r).sort();const i={root:"object"};return c.forEach((([e,t])=>{if("root"===e)return;const n=e.split("/"),o=n.pop(),r=n.join("/");"array"!==i[r]&&!isNaN(o)&&(i[r]="array"),0===t.length&&(i[e]="object")})),c=Object.entries(r).sort(),c.forEach((([e,t])=>{const[n,r,s]=function(e){let t,n,o;if("root"==e)return t="root",n="root",o=null,[t,n,o];const r=e.split("/");return 2===r.length&&(t="root",n="root",o=r.pop()),r.length>2&&(o=r.pop(),t=r.pop(),n=0===r.length?`root/${t}`:`${r.join("/")}/${t}`),[t,n,o]}(e),c=0===t.length,u=1===t.length;let l,d;if(c){if(o[`${r}/${s}`])return;return null==s?(d="object"===i.root?{}:[],l=["root",d,"root",[]],o.root=l,void a.push(l)):(d="object"===i[`${r}/${s}`]?{}:[],l=[s,d,`${r}/${s}`,[]],o[`${r}/${s}`]=l,void a.push(l))}if(!u)return l=[s,t,`${r}/${s}`,[]],o[`${r}/${s}`]=l,void a.push(l);if(o[`${r}`])o[r][1][s]=t[0];else{const e={};e[s]=t[0],l=[n,e,r,[]],o[r]=l,a.push(l)}})),a.reverse(),a.forEach((e=>{const[t,n,r]=e,a=r.replace(`/${t}`,""),s=o[a];a!==r&&s&&s[3].push(r)})),a.reverse(),[n({data:t}),o,a]},N=function(e){let t=[];return e.forEach((e=>{const[n,o,r]=e,a=o instanceof Array;let s="";"root"!==n&&(s=r.replace("root/","")),a?0==s.length?o.forEach(((e,n)=>t.push(["root",e]))):o.forEach((e=>t.push([s,e]))):Object.entries(o).forEach((([e,n])=>{0==s.length?t.push([e,n]):t.push([`${s}/${e}`,n])}))})),t};const I=e=>(t,n)=>{switch(e){case"std":case"standard":return w(t,n);case"tuple":case"tuples":return A(t,n);case"breadcrumb":case"breadcrumbs":const e=Object.entries(n);return A(t,e);case"file":case"files":const o=n.map((e=>{let t=e.split("/");1===t.length&&(t=["root"].concat(t));const n=t.pop();return[t.join("/"),n]}));return A(t,o);case"midFlat":return j(t,n)}return[["object",0],{}]};var F={from:function(e){return{toFlat:I(e)}},to:function(e,t,n){const o={},{walk:r}=t(),a=new Set,s=new Set;let c,i=0;switch(e){case"flat":case"dt-model":return r({data:n});case"std":case"standard":return O(n);case"midflat":case"midFlat":return T(n);case"tuple":case"tuples":return N(n);case"files":return c=N(n),c.map((([e,t])=>"function"==typeof t?`${e}/function:${t.name}`:t?.nodeType?`${e}/HtmlElement:${t.tagName?t.tagName.toLowerCase():"notSpecified"}`:"root"===e?t:`${e}/${t}`));case"breadcrumb":case"breadcrumbs":let e;return c=N(n),c.forEach((([e,t])=>a.has(e)?s.add(e):a.add(e))),c.forEach((([t,n])=>{s.has(t)?(e!==t&&(e=t,i=0),o["root"===t?i:`${t}/${i}`]=n,i++):o[t]=n})),o}}};function C(e,t,n){const o=e[t],r=o[2];o[2]=n,e[r]=o,o[3].forEach(((t,o)=>{const a=new RegExp(`^${r}/`),s=t.replace(a,`${n}/`);C(e[t],t,s)}))}var M={push:function(e){return function(t,n){const o=!!e[t]&&e[t][1];return o&&o instanceof Array?("object"==typeof value||o.push(n),this):this}},set:function(e,t){return function(n,o){const r=o instanceof Array,a=[];return a.push(n),r?a.push([...o]):a.push({...o}),a.push(n),a.push([]),e.push(a),t[n]=a,this}},connect:function(e){return function(t){t.forEach((t=>{let n=t.split("/");const o=n.pop(),r=n.pop(),a=e[r];if(!e[o])return this;if(!a)return this;if(a[1][o])return this;let s=`${a[2]}/${o}`;return C(e,o,s),a[3].includes(s)||a[3].push(s),this}))}},save:function(e){return function(t,n,o){const r=!!e[t]&&e[t][1];return r?(r[n]||(r[n]=o),this):this}}};const Z=["std","standard","tuple","tuples","breadcrumb","breadcrumbs","file","files","midFlat","midflat","flat","dt-model"],P={dependencies:()=>({walk:s,flatData:L,flatObject:p,convert:F,INIT_DATA_TYPES:Z,main:{load:P.load},isDTO:e=>"function"==typeof e.insertSegment,isDTM:e=>e instanceof Array&&e[0]instanceof Array&&4===e[0].length&&"root"===e[0][0],draft:M}),init(e,t={}){let{model:n}=Object.assign({},{model:"std"},t),o=P.dependencies;return Z.includes(n)?p(o,["flat","dt-model"].includes(n)?P.load(e):F.from(n).toFlat(o,e)):(console.error(`Can't understand your data-model: ${n}. Please, find what is possible on https://github.com/PeterNaydenov/dt-toolbox`),null)},load(e){const t={};e.forEach((e=>{const[,,n]=e;t[n]=e}));const n=s({data:e});return p(P.dependencies,[n,t,e])},flating(e,t={}){let{model:n}=Object.assign({},{model:"std"},t);if(!Z.includes(n))return null;let[,,o]=F.from("std").toFlat(P.dependencies,e);return o},converting(e,t={}){let{model:n,as:o}=Object.assign({},{model:"std",as:"std"},t);if(!Z.includes(n))return null;if(!Z.includes(o))return null;let[,,r]=F.from("std").toFlat(P.dependencies,e);return F.to(o,P.dependencies,r)},getWalk:()=>s},{init:Y,load:q,flating:X,converting:H,getWalk:W}=P,K={init:Y,load:q,flat:X,convert:H,getWalk:W};function U(e){const t={};e.look((({name:n,flatData:o,breadcrumbs:r,links:a,next:s})=>{if(e.set(n,o),"root"===n)return s();if(n===r&&e.connect([`root/${n}`]),a.forEach((([e,n])=>t[n]=[e,n])),t[n]){const[o,r]=t[n];e.connect([`${o}/${r}`])}return s()}))}function R(e){const t={};e.look((({name:n,flatData:o,links:r,next:a})=>{if(r.forEach((([e,n])=>{"root"!==e&&(t[n]=[e,n])})),e.set(n,o),t[n]){const[o,r]=t[n];e.connect([`${o}/${r}`])}return a()}))}function G(e,t){const n=t.export("root")[0][1],o=[];let r=null;e.use("root").look((({flatData:e,breadcrumbs:t,next:n})=>"root"===t?(r=e,n()):(o.push(t),n()))),r instanceof Array?e.set("root",[]):e.set("root",{}),o.forEach((o=>{let a=!1;const s={};t.query((t=>{t.from(o).look((({name:t,flatData:n,breadcrumbs:o,links:r,next:c})=>{if(a=!0,e.set(t,n),s.hasOwnProperty(o)){const[t,n]=s[o];e.connect([`${t}/${n}`])}return r.forEach((([e,t])=>s[`${o}/${t}`]=[e,t])),c()}))})),!a&&n.hasOwnProperty(o)&&(a=!0,e.save("root",o,r[o])),a||e.from(o).look((({name:t,flatData:n,breadcrumbs:o,links:r,next:a})=>{if(e.set(t,n),s.hasOwnProperty(o)){const[t,n]=s[o];e.connect([`${t}/${n}`])}return r.forEach((([e,t])=>s[`${o}/${t}`]=[e,t])),a()}))})),Object.entries(r).forEach((([o,r])=>{const a={};let s=!1;t.query((t=>{t.from(o).look((({name:t,flatData:n,breadcrumbs:o,links:r,next:c})=>{if(s=!0,e.set(t,n),a.hasOwnProperty(o)){const[t,n]=a[o];e.connect([`${t}/${n}`])}return r.forEach((([e,t])=>a[`${o}/${t}`]=[e,t])),c()}))})),!s&&n.hasOwnProperty(o)&&(s=!0,e.save("root",o,n[o])),s||e.save("root",o,r)}))}const B={_setTransitions:function(){return function(e,t){let n={},o={},r={};return e.forEach((e=>{const[a,s,c,i,u]=e,l=t[i],d=`${a}/${s}`;n[d]=l||null,o[d]=c,function(e){return e instanceof Array&&2==e.length&&(e.forEach((e=>{if(!1!==e||"string"!=typeof e)return!1})),!0)}(u)&&(r[d]=[],r[d][0]=u[0],r[d][1]=u[1])})),{transitions:n,nextState:o,chainActions:r}}},_updateStateData:function(e){return function(t){const{dtbox:n,query:o}=e.dependencies;let r="javascriptObject";return t.export&&(r="dt-object"),t instanceof Array&&t[0][0]===t[0][2]&&t.every((e=>4===e.length))&&(r="dt-model"),"javascriptObject"===r&&t instanceof Array?(console.error("State update failed. Reason: Received an array. Expectation: Object where top-level property name is the name of the data segment."),e.stateData):(["javascriptObject"].includes(r)&&(t=n.init(t).export()),["javascriptObject","dt-model"].includes(r)&&(t=n.load(t)),["javascriptObject","dt-model","dt-object"].includes(r)&&(t=t.query(o.splitSegments)),e.stateData.query(o.updateState,t))}},_updateStep:function(e){return function(t,n,o){const{askForPromise:r}=e.dependencies,a=r(),s=`${e.state}/${n}`,c=e.callback;e.lock=!0,e._transit(a,s,o),a.onComplete((n=>{let o=e._getChain(s),r=n.response;if(n.success){if(e.state=e.nextState[s],null!=n.stateData&&(e.stateData=e._updateStateData(n.stateData)),c.positive.forEach((t=>t(e.state,r))),c.transition.forEach((t=>t(e.state,r))),o&&o[0])return void e._updateStep(t,o[0],r)}else if(c.negative.forEach((t=>t(e.state,r))),c.transition.forEach((t=>t(e.state,r))),o&&o[1])return void e._updateStep(t,o[1],r);t.done(r)})),a.promise.catch((()=>console.log(`Failed in step ${s}`)))}},_warn:function(e){return function(e){Object.entries(e).forEach((([e,t])=>{null==t&&console.log(`Warning: Transition for ${e} is not defined`)}))}},_transit:function(e){return function(){const[t,n,...o]=arguments,{state:r,stateData:a,dependencies:s}=e,c=e.transitions[n],i=e.api.extractList;"function"==typeof c?c({task:t,state:r,extractList:i,dependencies:s},...o):t.done({success:!1})}},_getChain:function(e){return function(t){const n=e.chainActions;return!!n[t]&&n[t]}},_triggerCacheUpdate:function(e){return function(){if(0!==e.cache.length){const{updateTask:t,action:n,dt:o}=e.cache[0];e.cache=e.cache.reduce(((e,t,n)=>(0!=n&&e.push(t),e)),[]),e._updateStep(t,n,o),t.onComplete((t=>e._onUpdateTask(t)))}}},_onUpdateTask:function(e){return function(t){const n=e.callback,o=e.dependencies.askForPromise(n.update);n.update.forEach(((n,r)=>{n(e.state,t),o[r].done()})),o.onComplete((t=>{e.lock=!1,e._triggerCacheUpdate()}))}},setDependencies:function(e){return function(t){e.dependencies={...e.dependencies,...t}}},getDependencies:function(e){return function(){return e.dependencies}},on:function(e){return function(t,n){const o=e.callback;o[t]&&o[t].push(n)}},off:function(e){return function(t){e.callback[t]&&(e.callback[t]=[])}},importState:function(e){return function({state:t,stateData:n}){const{dtbox:o,query:r}=e.dependencies;if(t&&(e.state=t,n)){const t=o.load(n).query(r.splitSegments);e.stateData=e.stateData.query(r.updateState,t)}}},exportState:function(e){return function(){const{query:t}=e.dependencies;return{state:e.state,stateData:e.stateData.query(t.joinSegments).export()}}},update:function(e){return function(t,n){const{askForPromise:o}=e.dependencies,r=o();return e.lock?(e.cache.push({updateTask:r,action:t,dt:n}),r.promise):(e._updateStep(r,t,n),r.onComplete((t=>e._onUpdateTask(t))),r.promise)}},reset:function(e){return function(){const{dtbox:t}=e.dependencies;e.state=e.initialState,e.stateData=t.load(e.initialStateData.export())}},ignoreCachedUpdates:function(e){return function(){e.cache.forEach((({updateTask:e,action:t,dt:n})=>e.cancel(`Action '${t}' was ignored`))),e.cache=[]}},getState:function(e){return function(){return e.state}},extractList:function(e){return function(t,n=!1){const o=e.dependencies.query;return 0==arguments.length?e.stateData.query(o.joinSegments).model((()=>({as:"std"}))):n?e.stateData.extractList(t,n):e.stateData.extractList(t,e.stateDataFormat)}}},z=K.getWalk();function J({init:t,behavior:n,stateData:o={},debug:r,stateDataFormat:a={as:"std"}},s={}){const c=this,i={};c.state=t||"N/A",c.initialState=t||"N/A",c.stateDataFormat=a,c.lock=!1,c.cache=[],c.dependencies={walk:z,dtbox:K,askForPromise:e,query:{splitSegments:R,joinSegments:U,updateState:G}},c.callback={update:[],transition:[],positive:[],negative:[]};for(let e in B)e.startsWith("_")?c[e]=B[e](c):i[e]=B[e](c);c.api=i,c.stateData=K.init(o).query(R),c.initialStateData=K.init(o).query(R);const{transitions:u,nextState:l,chainActions:d}=c._setTransitions(n,s);return r&&(c._warn(u),global.debugFSM=c),c.transitions=u,c.nextState=l,c.chainActions=d,i}function Q(e,t){return{mouseDown:n=>{n.target.draggable||t&&t(n)||e.update("select",{event:n})},mouseUp:t=>{t.target.draggable?t.altKey?e.update("removeItem",{event:t}):t.shiftKey?e.update("addItem",{event:t}):e.update("newSelection",{event:t}):e.update("end",{event:t})},mouseMove:t=>{e.update("move",{event:t})},dragStart:t=>{e.update("drag",{event:t})},dragEnd:t=>{e.ignoreCachedUpdates(),e.update("end",{event:t})},dragOver:e=>e.preventDefault(),dragEnter:t=>e.update("move",{event:t}),drop:t=>e.update("drop",{event:t})}}J.dependencies={walk:z,dtbox:K,askForPromise:e,query:{splitSegments:R,joinSegments:U,updateState:G}};const V={minMax:function({startX:e,startY:t,newX:n,newY:o}){return{xMin:Math.min(e,n),xMax:Math.max(e,n),yMin:Math.min(t,o),yMax:Math.max(t,o)}},updateSelection:function(e,t){const{xMin:n,xMax:o,yMin:r,yMax:a}=e;t.style.left=`${n}px`,t.style.top=`${r}px`,t.style.width=o-n+"px",t.style.height=a-r+"px"},drawSelection:function(e,t){let n;return t?(n=t,n.style.visibility="visible"):(n=document.createElement("div"),n.style.position="absolute",n.style.border="1px dotted #333",document.getElementsByTagName("body")[0].appendChild(n)),n.style.left=`${e.clientX}px`,n.style.top=`${e.clientY}px`,n.style.width="20px",n.style.height="20px",n},targetList:function(e){return function(){let t=document.querySelectorAll("[draggable]"),n=[];return t.forEach((t=>{t.parentNode==e&&n.push(t)})),n}},findDropZone:function e(t,n){return"string"!=typeof t&&(t!==document&&("BODY"!=t.tagName&&(t.classList.contains(n)?t:e(t.parentNode,n))))},getEventFunctions:Q};const ee={onDrop:function({event:e,dropZone:t,dragged:n,selection:o,log:r,dragOffset:a}){t&&(o.forEach((e=>{e.parentNode.removeChild(e),t.appendChild(e)})),n.style="")},onStartDragging:function({event:e,selection:t,draggedTransperency:n,selectStyle:o}){t.forEach((e=>{e.style.opacity=n,e.classList.add(o)}))},onDropOut:function({event:e,dropZone:t,dragged:n,selection:o,log:r,dragOffset:a}){console.log("DROP OUT")}},te={init:"none",behavior:[["none","start","wait","setConfig",["start",!1]],["wait","start","ready","start"],["ready","addItem","ready","addSingleItem"],["ready","newSelection","ready","replaceSelection"],["ready","removeItem","ready","removeSingleItem"],["ready","select","inSelect","startSelection"],["inSelect","move","inSelect","changeSelection"],["inSelect","end","ready","endSelection"],["ready","drag","inDrag","startDragging"],["inDrag","end","ready","endDragging"],["inDrag","move","inDrag","changeDragZone"],["inDrag","drop","inDrag","drop"],["ready","disable","off","disable"],["off","enable","ready","enable"],["off","changeConfig","off","setConfig"],["ready","changeConfig","ready","setConfig"],["ready","destroy","end","destroy"],["off","destroy","end","destroy"]],stateData:{dropStyle:"dropzone",selectStyle:"dd-select",filter:!1,draggedTransperency:.5,selection:[],dragged:null,activeDropZone:null,activeZoneStyle:"actZone",selectDraw:null,mouseSelection:!1,hasDrop:!1,dragOffset:null,startX:0,startY:0,newX:!1,newY:!1}};const ne={start:function({task:e,dependencies:t},n){let{eFn:o}=t;document.addEventListener("mousedown",o.mouseDown),document.addEventListener("mousemove",o.mouseMove),document.addEventListener("mouseup",o.mouseUp),document.addEventListener("dragstart",o.dragStart),document.addEventListener("dragend",o.dragEnd),document.addEventListener("dragover",o.dragOver),document.addEventListener("dragenter",o.dragEnter),document.addEventListener("drop",o.drop),e.done({success:!0,response:n})},startSelection:function({task:e,dependencies:t,extractList:n},o){const{event:r}=o,{fn:a}=t,[s]=n(["selectDraw"]),c={};r.preventDefault(),c.selectDraw=a.drawSelection(r,s),c.mouseSelection=!0,c.startX=r.clientX,c.startY=r.clientY,e.done({success:!0,stateData:c})},changeSelection:function({task:e,dependencies:t,extractList:n},o){let{event:r}=o,{fn:a}=t,[s,c,i,u]=n(["mouseSelection","selectDraw","startX","startY"]);if(!s)return void e.done({success:!1});r.preventDefault();let l=r.clientX,d=r.clientY;a.updateSelection(a.minMax({startX:i,startY:u,newX:l,newY:d}),c),e.done({success:!0,stateData:{newX:l,newY:d}})},endSelection:function({task:e,dependencies:t,extractList:n},o){let{event:r}=o,{fn:a}=t,[s,c,i,u,l,d,f,p]=n(["selection","startX","startY","newX","newY","selectDraw","selectStyle","filter"]),g="new",h=[];if(r.preventDefault(),d.style.visibility="hidden",!u)return s.forEach((e=>e.classList.remove(f))),h=[],void e.done({success:!0,stateData:{selection:h}});r.altKey&&(g="reduce"),r.shiftKey&&(g="expand"),"expand"!==g&&s.forEach((e=>{e.classList.remove(f)}));let{xMin:m,xMax:y,yMin:v,yMax:b}=a.minMax({startX:c,startY:i,newX:u,newY:l}),S=document.querySelectorAll("[draggable]"),D=[];switch(p?S.forEach((e=>{e.classList.contains(p)&&D.push(e)})):S.forEach((e=>D.push(e))),D.forEach((e=>{let t=!0;if(t&&(t=e.offsetLeft>m),t&&(t=e.offsetTop>v),t){t=e.offsetLeft+e.clientWidth<y}if(t){t=e.offsetTop+e.clientHeight<b}t&&h.push(e)})),g){case"new":h=h.map((e=>(e.classList.add(f),e)));break;case"expand":h=h.reduce(((e,t)=>(e.includes(t)||(e.push(t),t.classList.add(f)),e)),h);break;case"reduce":h=h.reduce(((e,t)=>(h.includes(t)||(e.push(t),t.classList.add(f)),e)),[])}u=!1,l=!1,e.done({success:!0,stateData:{selection:h,mouseSelection:!1,newX:u,newY:l}})},addSingleItem:function({task:e,extractList:t},n){let{event:o}=n,r=o.target,[a,s,c]=t(["selection","selectStyle","filter"]),i=a.includes(r),u=!0;c&&(u=r.classList.contains(c)),!i&&u&&(a.push(r),r.classList.add(s)),e.done({success:!0,stateData:{selection:a}})},removeSingleItem:function({task:e,extractList:t},n){let{event:o}=n,r=o.target,[a,s]=t([a,s]);a=a.reduce(((e,t)=>(t!=r?e.push(t):t.classList.remove(s),e)),[]),e.done({success:!0,stateData:{selection:a}})},replaceSelection:function({task:e,extractList:t},n){let{event:o}=n,[r,a,s]=t(["selectStyle","filter","selection"]),c=o.target,i=!0;a&&(i=c.classList.contains(a)),i?(s.forEach((e=>e.classList.remove(r))),c.classList.add(r),s=[c],e.done({success:!0,stateData:{selection:s}})):e.done({success:!1})},startDragging:function({task:e,dependencies:t,extractList:n},o){let{event:r}=o,{target:a}=r,[s,c,i,u,l]=n(["draggedTransperency","selection","selectStyle","dropStyle","filter"]),{hooks:d,fn:f,deps:p}=t,g=!0,h={};l&&(g=a.classList.contains(l)),g?(0===c.length&&(c=[a]),d.onStartDragging({event:r,selection:c,draggedTransperency:s,selectStyle:i,dependencies:p}),h.dragged=a,h.dragOffset={x:r.offsetX,y:r.offsetY},h.selection=c,h.activeDropZone=f.findDropZone(a,u),e.done({success:!0,stateData:h})):e.done({success:!1})},changeDragZone:function({task:e,dependencies:t,extractList:n},o){let{event:r}=o,{fn:a}=t,[s,c,i,u]=n(["activeDropZone","dragged","activeZoneStyle","dropStyle"]),l=!1;if(c.parentNode!==r.target.parentNode){if(l=a.findDropZone(r.target,u),l)return l?(s&&s.classList.remove(i),l.classList.add(i),void e.done({success:!0,stateData:{activeDropZone:l}})):void e.done({success:!1});e.done({success:!1})}else e.done({success:!0})},endDragging:function({task:e,dependencies:t,extractList:n},o){let{hooks:r,fn:a,deps:s}=t,[c,i,u,l,d,f]=n(["activeDropZone","activeZoneStyle","dragged","selection","selectStyle","hasDrop","dependencies"]),{event:p}=o,g=[];if(!f){let e=!1;l.forEach((e=>{let t=a.targetList(e.parentNode),n={source:e.parentNode,target:!1,el:e,sourceList:t};g.push(n)})),r.onDropOut({event:p,dropZone:e,dragged:u,selection:l,log:g,dependencies:s})}c&&c.classList.remove(i),l.forEach((e=>{e.classList.remove(d),e.style.opacity="",e.style[0]||e.removeAttribute("style")})),c=null,l=[],f=!1,e.done({success:!0,stateData:{activeDropZone:c,selection:l,hasDrop:f}})},drop:function({task:e,dependencies:t,extractList:n},o){let{event:r}=o,[a,s,c,i,u]=n(["activeDropZone","dragged","selection","dropStyle","dragOffset"]),{hooks:l,fn:d,deps:f}=t,p=[],g=d.targetList(r.target),h=d.findDropZone(r.target,i),m=!1;r.preventDefault(),h==a&&(c.forEach((e=>{let t=d.targetList(e.parentNode),n={source:e.parentNode,target:h,el:e,targetList:g,sourceList:t};p.push(n)})),l.onDrop({event:r,dropZone:h,dragged:s,selection:c,log:p,dragOffset:u,dependencies:f}),m=!0),u=null,e.done({success:!0,stateData:{hasDrop:m,dragOffset:u}})},destroy:function({task:e,dependencies:t}){let{eFn:n}=t;document.removeEventListener("mousedown",n.mouseDown),document.removeEventListener("mousemove",n.mouseMove),document.removeEventListener("mouseup",n.mouseUp),document.removeEventListener("dragstart",n.dragStart),document.removeEventListener("dragend",n.dragEnd),document.removeEventListener("dragover",n.dragOver),document.removeEventListener("dragenter",n.dragEnter),document.removeEventListener("drop",n.drop),e.done({success:!0})},setConfig:function({task:e},t={}){let{hooks:n,config:o}=t,r={};n||(n={}),o||(o={}),o.onStartDragging&&(n.onStartDragging=o.onStartDragging),o.onDrop&&(n.onDrop=o.onDrop),o.onDropOut&&(n.onDropOut=o.onDropOut),o.dropStyle&&"string"==typeof o.dropStyle&&(r.dropStyle=o.dropStyle),o.draggedTransperency&&"number"==typeof o.draggedTransperency&&(r.draggedTransperency=o.draggedTransperency),o.activeZoneStyle&&"string"==typeof o.activeZoneStyle&&(r.activeZoneStyle=o.activeZoneStyle),o.selectStyle&&"string"==typeof o.selectStyle&&(r.selectStyle=o.selectStyle),o.filter&&"string"==typeof o.filter&&(r.filter=o.filter),o.dependencies?r.dependencies=o.dependencies:r.dependencies={},e.done({success:!0,stateData:r,response:n})},disable:function({task:e}){e.done({success:!0})},enable:function({task:e}){e.don({success:!0})}};function oe(e={}){const t=new J(te,ne),n=Q(t,e.ignoreSelect);return window.dd=t,t.setDependencies({deps:e.dependencies}),t.setDependencies({eFn:n,fn:V}),t.update("start",{config:e,hooks:ee}).then((e=>t.setDependencies({hooks:e}))).then((()=>({changeConfig:e=>{t.update("changeConfig",{hooks:ee,config:e}).then((e=>t.setDependencies({hooks:e})))},destroy:()=>t.update("destroy"),disable:()=>t.update("disable"),enable:()=>t.update("enable")})))}export{oe as default};
//# sourceMappingURL=drag-drop.esm.mjs.map
